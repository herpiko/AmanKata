<!doctype html>

<html>
  
  <head>
    <title>Chat Sekjar</title>
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" href="/static/bootstrap.min.css">
	<script type="text/javascript" src="/static/jquery.min.js"></script>
	<script type="text/javascript" src="/static/bootstrap.min.js"></script>
	<script type="text/javascript" src="/static/socket.io.min.js"></script>
	<script type="text/javascript" src="/static/aes-cbc-bbs.js"></script>
	<script type="text/javascript" src="/static/jquery.storageapi.min.js"></script>
	<style>
		.pagination-centered {
		  text-align: center;
		}
	
	  	.bs-sidebar.affix {
	    	width: 450px;
	    	//padding-left: 20px;
	  	}
		
		.bs-callout {
		    margin: 20px 0;
		    padding: 20px;
		}

		.bs-callout-left {
		    border-left: 3px solid #eee;
		}

		.bs-callout-right {
		    border-right: 3px solid #eee;
		}

		.bs-callout h4 {
		    margin-top: 0;
		    margin-bottom: 5px;
		}

		.bs-callout p:last-child {
		    margin-bottom: 0;
		}

		.bs-callout code {
		    background-color: #fff;
		    border-radius: 3px;
		}

		.bs-callout-danger {
		    background-color: #fdf7f7;
		    border-color: #d9534f;
		}

		.bs-callout-danger h4 {
		    color: #d9534f;
		}

		.bs-callout-warning {
		    background-color: #fcf8f2;
		    border-color: #f0ad4e;
		}

		.bs-callout-warning h4 {
		    color: #f0ad4e;
		}

		.bs-callout-info {
		    background-color: #f4f8fa;
		    border-color: #5bc0de;
		}

		.bs-callout-info h4 {
		    color: #5bc0de;
		}
	</style>
  </head>
  
  <body>
    <div class="container">
      <div class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
            </button>
            <a href="#" class="navbar-brand"><strong>A</strong>man<strong>K</strong>ata - as <span id="tag_user_id"></span></a>
          </div>
        </div>
      </div>

      <div class="row-fluid" id="gambar_loading">
		<div class="span12 pagination-centered">
			Loading...
			<br/>
			<img src="/static/ajax-loader.gif"/>
		</div>
	  </div>

      <div class="row" id="main_chat">
        <div class="col-md-12">
          <!-- Nav tabs -->
          <ul id="group_header" class="nav nav-tabs">
            <li class="active">
              <a class="group_header_a" data-id="home" href="#home" data-toggle="tab">Dashboard</a>
            </li>
          </ul>
          <!-- Tab panes -->
          <div id="group_content" class="tab-content">

            <div class="tab-pane active" id="home">
              <br>
              If you want to create a new chat session, click this button<br><br>
              <a id="create_new_group" class="btn btn-primary">Create a new Chat Session</a><br>
              <br><br>
            </div>

          </div>

          <div id="chat_bar">
			<p>Send your message here.</p>
			<textarea class="form-control" id="chat_message" rows="3"  style="width: 75%"></textarea>
			<br/>
			<button id="send" class="btn btn-primary">Send</button>
		  </div>

          <br>
          <a href="/" id="logout">Do Logout, remove my credentials from HTML5 Storage</a>
        </div>
      </div>
    </div>

    <div class="modal fade" id="create_group_modal">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	        <h4 class="modal-title">Create New Group</h4>
	      </div>
	      <div class="modal-body">
	      	  <div class="well">
	            <input type="text" id="text_user" class="form-control" placeholder="Add new user ID">
	            <br>
	             <a id="add_user_id" class="btn btn-primary btn-xs">Add User ID</a>
	             <br><br>
	            <ul class="list-group" id="list_user_id">
	            </ul>
	            <br>
	            <button id="start_group_chat" class="btn btn-success">Start Group Chat</button>
	          </div>
	      </div>
	      <div class="modal-footer">
	        <!-- <button type="button" class="btn btn-primary">Start Chat</button> -->
	        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
	      </div>
	    </div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

  </body>

</html>

<script type="text/javascript">
  $(document).ready(function() {
  	
  	$('#main_chat').hide();
  	$('#chat_bar').hide();

  	var current_group_id, groups, data_storage, user_id, password;
  	var socket = io.connect('http://' + document.domain + ':' + location.port);
  	groups = {};

  	if ($.localStorage.isEmpty('AmanKataCert')) {
  		window.location.href = "/";
  	} else {
  		data_storage = $.localStorage.get('AmanKataCert');
  		user_id = data_storage['user_id'];
  		password = data_storage['password'];

  		socket.emit('doLogin', {'user_id': user_id, 'password': password}, function(result) {
	        if (result) {
	        	//chat dimulai.
	        	$('#tag_user_id').text(user_id);
	        	socket.emit('requestGroupSession', function(result_group) {
	        		$.each(result_group, function(i, data_group) {
	        			var data = data_group.group_id;
	        			groups[data] = data_group;
	        			$('#group_header').append('<li><a class="group_header_a" data-id="'+data+'" href="#'+data+'" data-toggle="tab">#'+data+'<span class="glyphicon glyphicon-exclamation-sign" id="'+data+'_sign"></span></a></li>');
	        			$('#group_content').append('<div class="tab-pane" id="'+data+'"><div class="row"><div class="col-md-9" id="'+data+'_group_message"></div><div class="col-md-3"><br><b>Group Member:</b><br><ul class="list-group" id="'+data+'_group_member"></ul></div></div></div>');
	        			$('#'+data+'_sign').hide();
	        			$.each(data_group.group_guest_user_id, function(key, value) {
	        				$('#'+data+'_group_member').append('<li class="list-group-item">'+value+'</li>');
	        			});
	        			console.log(data_group);
	        		});
	        		$('.group_header_a').click(function() {
				  		current_group_id = $(this).data('id');
				  		if (current_group_id == 'home') {
				  			$('#chat_bar').hide();
				  		} else {
				  			$('#'+current_group_id+'_sign').hide();
				  			$('#chat_bar').show();
				  		}
				  	});
	        		$('#gambar_loading').fadeOut(500, function() {
						$('#main_chat').fadeIn(500);
					});
	        	});

	        } else {
	        	$.localStorage.removeAll();
	        	alert('Error!');
	        	window.location.href = "/";
	        }
		});
  	}

  	socket.on('retrieveChatClient', function(data) {
  		var new_message_from_user_id = data.from;
  		var new_message_from_group_id = data.group_id;
  		var new_message_content = data.the_message;
  		var $elem = $('#'+new_message_from_group_id+'_group_message');

		$elem.append('<div class="bs-callout bs-callout-left bs-callout-warning"><h4>'+new_message_from_user_id+'</h4><p>'+new_message_content+'</p></div>');
		if (current_group_id != new_message_from_group_id) {
			$('#'+new_message_from_group_id+'_sign').show();	
		}
		$('html, body').animate({scrollTop: $elem.height()}, 800);
	});

  	function sendChat(obj) {
  		socket.emit('sendChat', obj);
  	}

  	function updateChat() {
  		var chat_message = $('#chat_message').val();
  		if (!chat_message) return;
  		$('#'+current_group_id+'_group_message').append('<div class="bs-callout bs-callout-right bs-callout-info text-right"><h4>you</h4><p>'+chat_message+'</p></div>');
  		
  		if (user_id != groups[current_group_id]['group_host_user_id']) {
  			sendChat({'to':groups[current_group_id]['group_host_user_id'], 'from': user_id, 'group_id': current_group_id, 'the_message': chat_message});
  		}
  		$.each(groups[current_group_id]['group_guest_user_id'], function(i, data_group) {
			if (user_id != data_group) {
				sendChat({'to':data_group, 'from': user_id, 'group_id': current_group_id, 'the_message': chat_message});
			}
		});
  		var $elem = $('#'+current_group_id+'_group_message');
		$('#chat_message').val('');
		$('html, body').animate({scrollTop: $elem.height()}, 800);
		$('#chat_message').focus();
  	}

  	$('#send').click(function() {
  		updateChat();
  	});

	$('#chat_message').keyup(function(event) {
		if ( event.which == 13 ) {
			updateChat();
		}
	});

  	$('#create_new_group').click(function() {
  		$( "#list_user_id li" ).each(function() {
			$( this ).remove();
		});
  		$('#create_group_modal').modal('show');
  	});

  	$('#add_user_id').click(function() {
  		var text_user = $('#text_user').val();
  		if (!text_user) return;
  		$('#text_user').val('');
  		$('#list_user_id').append('<li class="list-group-item">'+text_user+'</li>');
  	});

  	$('#start_group_chat').click(function() {
  		var size = $("#list_user_id li").length;
  		if (size < 1) {
  			alert("Chat Minimal 2 User");
  			return;
  		}
  		var data_group = {
  			'group_host_user_id' : user_id,
  			'group_guest_user_id' : []
  		};
  		$( "#list_user_id li" ).each(function() {
  			data_group['group_guest_user_id'].push($( this ).text());
		});
		socket.emit("newGroup", data_group, function(result) {
			if (result) {
				alert("Group Created");
				window.location.href = "/chat";
			} else {
				alert("Group Failed to Create");
			}
			$('#create_group_modal').modal('hide');
		});
  	});

  	$('#logout').click(function() {
  		$.localStorage.removeAll();
  	});

  });
</script>